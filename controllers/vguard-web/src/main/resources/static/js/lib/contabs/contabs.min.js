$(function() {
	//计算元素集合的总宽度
	function f(l) {
		var k = 0;
		$(l).each(function() {
			k += $(this).outerWidth(true)
		});
		return k
	}
	//滚动到指定选项卡
	function g(n) {
		var o = f($(n).prevAll()), q = f($(n).nextAll());
		// 可视区域非tab宽度
		var l = f($(".content-tabs").children().not(".J_menuTabs"));
		//可视区域tab宽度
		var k = $(".content-tabs").outerWidth(true) - l;
		//实际滚动宽度
		var p = 0;
		if ($(".page-tabs-content").outerWidth() < k) {
			p = 0
		} else {
			if (q <= (k - $(n).outerWidth(true) - $(n).next().outerWidth(true))) {
				if ((k - $(n).next().outerWidth(true)) > q) {
					p = o;
					var m = n;
					while ((p - $(m).outerWidth()) > ($(".page-tabs-content")
							.outerWidth() - k)) {
						p -= $(m).prev().outerWidth();
						m = $(m).prev()
					}
				}
			} else {
				if (o > (k - $(n).outerWidth(true) - $(n).prev().outerWidth(
						true))) {
					p = o - $(n).prev().outerWidth(true)
				}
			}
		}
		$(".page-tabs-content").animate({
			marginLeft : 0 - p + "px"
		}, "fast")
	}
	//查看左侧隐藏的选项卡
	function a() {
		var o = Math.abs(parseInt($(".page-tabs-content").css("margin-left")));
		var l = f($(".content-tabs").children().not(".J_menuTabs"));
		var k = $(".content-tabs").outerWidth(true) - l;
		var p = 0;
		if ($(".page-tabs-content").width() < k) {
			return false
		} else {
			var m = $(".J_menuTab:first");
			var n = 0;
			while ((n + $(m).outerWidth(true)) <= o) {
				n += $(m).outerWidth(true);
				m = $(m).next()
			}
			n = 0;
			if (f($(m).prevAll()) > k) {
				while ((n + $(m).outerWidth(true)) < (k) && m.length > 0) {
					n += $(m).outerWidth(true);
					m = $(m).prev()
				}
				p = f($(m).prevAll())
			}
		}
		$(".page-tabs-content").animate({
			marginLeft : 0 - p + "px"
		}, "fast")
	}
	//查看右侧隐藏的选项卡
	function b() {
		var o = Math.abs(parseInt($(".page-tabs-content").css("margin-left")));
		var l = f($(".content-tabs").children().not(".J_menuTabs"));
		var k = $(".content-tabs").outerWidth(true) - l;
		var p = 0;
		if ($(".page-tabs-content").width() < k) {
			return false
		} else {
			var m = $(".J_menuTab:first");
			var n = 0;
			while ((n + $(m).outerWidth(true)) <= o) {
				n += $(m).outerWidth(true);
				m = $(m).next()
			}
			n = 0;
			while ((n + $(m).outerWidth(true)) < (k) && m.length > 0) {
				n += $(m).outerWidth(true);
				m = $(m).next()
			}
			p = f($(m).prevAll());
			if (p > 0) {
				$(".page-tabs-content").animate({
					marginLeft : 0 - p + "px"
				}, "fast")
			}
		}
	}
	//通过遍历给菜单项加上data-index属性
	$(".J_menuItem").each(function(k) {
		if (!$(this).attr("data-index")) {
			$(this).attr("data-index", k)
		}
	});
	//	二级菜单的点击事件
	function c() {
		var o = $(this).attr("href"), m = $(this).data("index"), l = $.trim($(
				this).text()), k = true;
		if (o == undefined || $.trim(o).length == 0) {
			return false;
		}
		
		//判断雪城环保系列菜单路径并将当前用户名拼接至参数
		var curUserName = $("#username").val();
		if (-1 < o.indexOf("client-auth") 
			&& -1 < o.indexOf("accountName")
			&& o.lastIndexOf("=") == (o.length - 1)) {
			o += curUserName;
		}
		
		//访问乐科外呼系统页面时，读取配置文件，赋上乐科外呼服务器地址等信息
		if (-1 < o.indexOf("happicall_comm")) {
			$.ajax({
				   url: BASE_URL + "/config/outCallInfo.json",
				   type: "GET",
				   dataType: "json",
				   async: false,
				   success: function(data) {
					   o += ("&AGENTID=" + data.adminUser + "&PWD=" + data.adminPwd);
				   }
			});
		}
		
//		console.log("菜单url--》" + o);
		
		// 选项卡菜单已存在
		$(".J_menuTab").each(
				function() {
					if ($(this).data("id") == o) {
						if (!$(this).hasClass("active")) {
							$(this).addClass("active").siblings(".J_menuTab")
									.removeClass("active");
							g(this);
							// 显示tab对应的内容区
							$(".J_mainContent .J_iframe").each(
									function() {
										if ($(this).data("id") == o) {
											$(this).show()
													.siblings(".J_iframe")
													.hide();
											return false
										}
									})
						}
						k = false;
						return false
					}
				});
		// 选项卡菜单不存在
		if (k) {
//			该部分为限制选项卡数量代码
//			var count = $('.J_menuTab').length;
//			if(count > 10){
//				parent.toast("请关闭部分tab页！");
//				return false;
//			}
			var p = '<a href="javascript:;" class="active J_menuTab" data-id="'
					+ o + '">' + l
					+ ' <i class="glyphicon glyphicon-remove-circle"></i><u class="trangleBottom"></u></a>';
			$(".J_menuTab").removeClass("active");
//			适应环保信息，路径为环保模块时去掉内部padding值的影响，下面为修改部分
			var strs = o.split('=');
			var isrc = strs[strs.length-1];
			if(isrc == "admin/dam/general/realTime"){
				var n = '<iframe class="J_iframe" name="iframe' + m
				+ '" width="100%" height="100%" src="' + o
				+ '" frameborder="0" data-id="' + o
				+ '" seamless style="margin-top: -20px;height: calc( 100% + 20px);"></iframe>';
			}
			else{
				var n = '<iframe class="J_iframe" name="iframe' + m
				+ '" width="100%" height="100%" src="' + o
				+ '" frameborder="0" data-id="' + o
				+ '" seamless></iframe>';
			};
//          修改结束，下面的注释部分为原代码
				
//			var n = '<iframe class="J_iframe" name="iframe' + m
//					+ '" width="100%" height="100%" src="' + o
//					+ '" frameborder="0" data-id="' + o
//					+ '" seamless></iframe>';
			$(".J_mainContent").find("iframe.J_iframe").hide().parents(
					".J_mainContent").append(n);
			$(".J_menuTabs .page-tabs-content").append(p);
			g($(".J_menuTab.active"))
		}else{
			$(".J_iframe[data-id='"+o+"']").attr("src",o);//如果界面已经打开重新加载界面
		}
//		隐藏二级菜单
//		$('.subnav').hide();
//		$('#page-wrapper').css('margin-left','75');
		return false
	}
	$(".J_menuItem").on("click", c);
	// 关闭选项卡菜单
	function h() {
		var m = $(this).parents(".J_menuTab").data("id");
		var l = $(this).parents(".J_menuTab").width();
		// 当前元素处于选中状态
		if ($(this).parents(".J_menuTab").hasClass("active")) {
			// 当前元素后面有选项卡，默认选中后面的选项卡
			if ($(this).parents(".J_menuTab").next(".J_menuTab").size()) {
				var k = $(this).parents(".J_menuTab").next(".J_menuTab:eq(0)")
						.data("id");
				$(this).parents(".J_menuTab").next(".J_menuTab:eq(0)")
						.addClass("active");
				$(".J_mainContent .J_iframe").each(function() {
					if ($(this).data("id") == k) {
						$(this).show().siblings(".J_iframe").hide();
						return false
					}
				});
				var n = parseInt($(".page-tabs-content").css("margin-left"));
				if (n < 0) {
					$(".page-tabs-content").animate({
						marginLeft : (n + l) + "px"
					}, "fast")
				}
				$(this).parents(".J_menuTab").remove();
				$(".J_mainContent .J_iframe").each(function() {
					if ($(this).data("id") == m) {
						$(this).remove();
						return false
					}
				})
			}
			// 当前元素后面有选项卡，默认选中前面的选项卡
			if ($(this).parents(".J_menuTab").prev(".J_menuTab").size()) {
				var k = $(this).parents(".J_menuTab").prev(".J_menuTab:last")
						.data("id");
				$(this).parents(".J_menuTab").prev(".J_menuTab:last").addClass(
						"active");
				$(".J_mainContent .J_iframe").each(function() {
					if ($(this).data("id") == k) {
						$(this).show().siblings(".J_iframe").hide();
						return false
					}
				});
				$(this).parents(".J_menuTab").remove();
				$(".J_mainContent .J_iframe").each(function() {
					if ($(this).data("id") == m) {
						$(this).remove();
						return false
					}
				})
			}
		} 
		// 当前元素未选中
		else {
			$(this).parents(".J_menuTab").remove();
			$(".J_mainContent .J_iframe").each(function() {
				if ($(this).data("id") == m) {
					$(this).remove();
					return false
				}
			});
			g($(".J_menuTab.active"))
		}
		return false
	}
	$(".J_menuTabs").on("click", ".J_menuTab i", h);
	
	function i() {
		$(".page-tabs-content").children("[data-id]").not(":first").not(
				".active").each(function() {
			$('.J_iframe[data-id="' + $(this).data("id") + '"]').remove();
			$(this).remove()
		});
		$(".page-tabs-content").css("margin-left", "0")
	}
	$(".J_tabCloseOther").on("click", i);
	function j() {
		g($(".J_menuTab.active"))
	}
	$(".J_tabShowActive").on("click", j);
	function e() {
		if (!$(this).hasClass("active")) {
			var k = $(this).data("id");
			$(".J_mainContent .J_iframe").each(function() {
				if ($(this).data("id") == k) {
					$(this).show().siblings(".J_iframe").hide();
					return false
				}
			});
			$(this).addClass("active").siblings(".J_menuTab").removeClass(
					"active");
			g(this)
		}
	}
	$(".J_menuTabs").on("click", ".J_menuTab", e);
	function d() {
		var l = $('.J_iframe[data-id="' + $(this).data("id") + '"]');
		var k = l.attr("src")
	}
	$(".J_menuTabs").on("dblclick", ".J_menuTab", d);
	$(".J_tabLeft").on("click", a);
	$(".J_tabRight").on("click", b);
	$(".J_tabCloseAll")
			.on(
					"click",
					function() {
						$(".page-tabs-content").children("[data-id]").not(
								":first")
								.each(
										function() {
											$(
													'.J_iframe[data-id="'
															+ $(this)
																	.data("id")
															+ '"]').remove();
											$(this).remove()
										});
						$(".page-tabs-content").children("[data-id]:first")
								.each(
										function() {
											$(
													'.J_iframe[data-id="'
															+ $(this)
																	.data("id")
															+ '"]').show();
											$(this).addClass("active")
										});
						$(".page-tabs-content").css("margin-left", "0")
					})
});